import "module:std" as std

import { AuthEndpoint } from "./segments/auth.ht"
import { AudioSourceEndpoint } from './segments/audio_source.ht'
import { CorePlugin } from './segments/core.ht'

var HttpClient = std.HttpClient
var HttpBaseOptions = std.HttpBaseOptions

class DABMusicAudioSourcePlugin {
  var auth: AuthEndpoint
  var audioSource: AudioSourceEndpoint
  var core: CorePlugin

  var api: HttpClient
  
  construct (){
    api = HttpClient(
      HttpBaseOptions(
        baseUrl: "https://dab.yeet.su/api"
      )
    )
    
    auth = AuthEndpoint(api)
    core = CorePlugin(api)
    // Pass auth object itself so AudioSourceEndpoint always reads live credentials
    audioSource = AudioSourceEndpoint(api, auth)

    auth.authStateStream.listen((event) {
      setAccessToken()
    })
  }

  fun setAccessToken() {
    api = HttpClient(
      HttpBaseOptions(
        baseUrl: "https://dab.yeet.su/api",
        headers: {
            "Cookie": auth.getCookieHeaderValue()
        }.toJson()
      )
    )

    // Update the api on auth and audioSource with the new authenticated client
    auth.updateApi(api)
    audioSource = AudioSourceEndpoint(api, auth)
  }
}

export { DABMusicAudioSourcePlugin }
